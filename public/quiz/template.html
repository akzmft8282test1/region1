<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>í€´ì¦ˆ ì°¸ê°€</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">í€´ì¦ˆ ì°¸ê°€</h1></header>

    <main style="padding: 1.25rem; flex: 1">
      <section id="nicknameSection" class="card" aria-label="ë‹‰ë„¤ì„ ì…ë ¥">
        <label for="nicknameInput">ë‹‰ë„¤ì„</label>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem">
          <input
            id="nicknameInput"
            type="text"
            placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
            class="input-text"
            aria-label="ë‹‰ë„¤ì„ ì…ë ¥"
          />
          <button id="joinBtn" class="btn-primary">ì°¸ê°€</button>
        </div>
        <p style="color: var(--muted); margin-top: 0.5rem">
          ì´ ì‚¬ì´íŠ¸ëŠ” IP/localStorageë¡œ ì„¸ì…˜ì„ ë³´ì¡´í•©ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ë„
          ì§„í–‰/ì ìˆ˜ê°€ ìœ ì§€ë©ë‹ˆë‹¤.
        </p>
      </section>

      <section
        id="questionBox"
        class="card"
        aria-live="polite"
        style="display: none"
      >
        <h2 id="questionText"></h2>
        <img
          id="questionImage"
          style="
            max-width: 320px;
            display: none;
            margin: 0.5rem auto;
            border-radius: 8px;
          "
          alt="ë¬¸ì œ ì´ë¯¸ì§€"
        />
        <div id="answers"></div>

        <div id="timer" style="margin-top: 0.6rem">
          â³ ë‚¨ì€ ì‹œê°„: <span id="timeLeft">0</span>s
        </div>
        <div id="scoreHint" style="margin-top: 0.4rem; color: var(--muted)">
          ë¹ ë¥´ê²Œ ë§ì¶œìˆ˜ë¡ ì ìˆ˜ê°€ í½ë‹ˆë‹¤. ë‘ ë°° ë¬¸ì œëŠ” í‘œì‹œë©ë‹ˆë‹¤.
        </div>

        <div id="feedback" style="margin-top: 0.6rem; font-weight: 700"></div>
      </section>
    </main>

    <footer class="footer">Â© 2025 QuizMaker</footer>

    <script>
      const slug = window.location.pathname.split("/").pop();

      // DOM
      const nicknameInput = document.getElementById("nicknameInput");
      const joinBtn = document.getElementById("joinBtn");
      const nicknameSection = document.getElementById("nicknameSection");
      const questionBox = document.getElementById("questionBox");
      const questionText = document.getElementById("questionText");
      const questionImage = document.getElementById("questionImage");
      const answersEl = document.getElementById("answers");
      const timeLeftEl = document.getElementById("timeLeft");
      const feedbackEl = document.getElementById("feedback");

      // state
      let playerId = localStorage.getItem("playerId") || null;
      let nicknameStored = localStorage.getItem("nickname") || null;
      let gameId = null;
      let currentQuestion = null;
      let timerInterval = null;
      let questionStartTime = null;

      // local progression state (ì°¸ê°€ì ê°œë³„ ì§„í–‰)
      let _localQuestions = [];
      let _localIndex = 0;

      // helper: get or create game record by slug
      async function ensureGameRecord() {
        const { data: game } = await db
          .from("games")
          .select("id,started,current_question_ord,ended,quiz_id")
          .eq("slug", slug)
          .maybeSingle();
        if (!game) return null;
        gameId = game.id;
        return game;
      }

      // join / session restore
      async function joinGame() {
        try {
          const game = await ensureGameRecord();
          if (!game) {
            safeAlert("ì•„ì§ í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
          }

          if (playerId) {
            const { data: p } = await db
              .from("players")
              .select("*")
              .eq("id", playerId)
              .maybeSingle();
            if (p && p.game_id === gameId) {
              nicknameStored = p.nickname;
              nicknameInput.value = nicknameStored;
              nicknameSection.style.display = "none";
              questionBox.style.display = "block";

              // ì°¸ê°€ìëŠ” ì „ì²´ ë¬¸ì œ ëª©ë¡ì„ ë¡œì»¬ë¡œ ë¡œë“œí•˜ì—¬ ê°œë³„ ì§„í–‰
              const { data: questions } = await db
                .from("questions")
                .select(
                  "id,ord,text,image_url,timeout,double_points,answers(*)",
                )
                .eq("quiz_id", game.quiz_id)
                .order("ord");
              _localQuestions = questions || [];

              subscribeGame(gameId);

              // ê²Œì„ì´ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìœ¼ë©´ ê°œì¸ ì§„í–‰ ì‹œì‘
              if (game.started) startLocalQuiz();
              else {
                questionText.textContent =
                  "í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...";
              }
              return;
            } else {
              localStorage.removeItem("playerId");
              playerId = null;
            }
          }

          const nickname = nicknameInput.value.trim();
          if (!nickname) {
            safeAlert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          const { data: newPlayer, error } = await db
            .from("players")
            .insert([{ game_id: gameId, nickname, points: 0 }])
            .select()
            .single();
          if (error) throw error;
          playerId = newPlayer.id;
          localStorage.setItem("playerId", playerId);
          localStorage.setItem("nickname", nickname);
          nicknameSection.style.display = "none";
          questionBox.style.display = "block";

          // ì°¸ê°€ìëŠ” ì „ì²´ ë¬¸ì œ ëª©ë¡ì„ ë¡œì»¬ë¡œ ë¡œë“œí•˜ì—¬ ê°œë³„ ì§„í–‰
          const { data: questions } = await db
            .from("questions")
            .select("id,ord,text,image_url,timeout,double_points,answers(*)")
            .eq("quiz_id", game.quiz_id)
            .order("ord");
          _localQuestions = questions || [];

          subscribeGame(gameId);

          // ê²Œì„ì´ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìœ¼ë©´ ê°œì¸ ì§„í–‰ ì‹œì‘
          if (game.started) startLocalQuiz();
          else {
            questionText.textContent =
              "í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...";
          }
        } catch (err) {
          console.error("joinGame error", err);
          safeAlert("ì°¸ê°€ ì‹¤íŒ¨: " + (err.message || err));
        }
      }

      joinBtn.addEventListener("click", joinGame);

      function subscribeGame(gameIdLocal) {
        db.channel("games-" + gameIdLocal)
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "games",
              filter: `id=eq.${gameIdLocal}`,
            },
            (payload) => {
              const g = payload.new;
              if (g.ended) {
                window.location.href = `/quiz/${slug}/leaderboard`;
              }
              // í˜¸ìŠ¤íŠ¸ê°€ startedë¥¼ trueë¡œ ì„¤ì •í•˜ë©´ ê°œì¸ ì§„í–‰ ì‹œì‘
              if (g.started) {
                // only start if local questions exist
                if (_localQuestions && _localQuestions.length > 0) {
                  startLocalQuiz();
                } else {
                  // attempt to fetch questions if not loaded yet
                  (async () => {
                    const { data: game } = await db
                      .from("games")
                      .select("quiz_id")
                      .eq("id", gameId)
                      .single();
                    const { data: questions } = await db
                      .from("questions")
                      .select(
                        "id,ord,text,image_url,timeout,double_points,answers(*)",
                      )
                      .eq("quiz_id", game.quiz_id)
                      .order("ord");
                    _localQuestions = questions || [];
                    if (_localQuestions.length > 0) startLocalQuiz();
                  })();
                }
              }
            },
          )
          .subscribe();
      }

      // --- ê°œì¸ ì§„í–‰ ë¡œì§: startLocalQuiz / renderLocalQuestion / submitAnswerAndNext ---
      function startLocalQuiz() {
        _localIndex = 0;
        if (!Array.isArray(_localQuestions) || _localQuestions.length === 0) {
          questionText.textContent = "ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        renderLocalQuestion(_localIndex);
      }

      function renderLocalQuestion(idx) {
        const question = _localQuestions[idx];
        if (!question) {
          // ê°œì¸ ì™„ë£Œ: ë¦¬ë”ë³´ë“œë¡œ ì´ë™ (í˜¸ìŠ¤íŠ¸ê°€ ì•„ì§ ëª¨ë“  ì°¸ê°€ì ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ê²½ìš°ë„ ìˆê³ ,
          // í˜¸ìŠ¤íŠ¸ì˜ checkAllFinishedê°€ ë™ì‘í•˜ë©´ ì „ì²´ ë¦¬ë”ë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™ë©ë‹ˆë‹¤)
          window.location.href = `/quiz/${slug}/leaderboard`;
          return;
        }
        currentQuestion = question;
        renderQuestionLocal(question);
      }

      // ë Œë”ë§ í•¨ìˆ˜: ê¸°ì¡´ renderQuestionê³¼ ìœ ì‚¬í•˜ì§€ë§Œ 'question' êµ¬ì¡°ëŠ” answers í¬í•¨
      async function renderQuestionLocal(question) {
        // reuse current render UI
        questionText.textContent = question.text || "(ë¬¸ì œ ì—†ìŒ)";
        if (question.image_url) {
          questionImage.src = question.image_url;
          questionImage.style.display = "block";
        } else {
          questionImage.style.display = "none";
        }

        answersEl.innerHTML = "";
        // answers may be nested under question.answers
        const answers = question.answers || [];
        answers.forEach((a) => {
          const btn = document.createElement("button");
          btn.className = "answer-btn";
          btn.textContent = a.text || "ë³´ê¸°";
          btn.onclick = () => submitAnswerAndNext(question, a);
          answersEl.appendChild(btn);
        });

        // start timer for this local question
        clearTimer();
        questionStartTime = Date.now();
        startTimer(question.timeout || 30, () => {
          // timeout -> auto submit null (ì˜¤ë‹µ) and advance
          submitAnswerAndNext(question, null);
        });
      }

      // wrapper: ì œì¶œ í›„ ê°œì¸ ì¸ë±ìŠ¤ ì¦ê°€ ë° ë‹¤ìŒ ë¬¸ì œ ë Œë”
      async function submitAnswerAndNext(question, answerObj) {
        // call existing submitAnswer (which writes player_answers and updates points)
        await submitAnswer(question, answerObj);

        // advance local index
        _localIndex += 1;
        // small delay for feedback readability
        setTimeout(() => {
          renderLocalQuestion(_localIndex);
        }, 600);
      }

      // ê¸°ì¡´ init/render/submit í•¨ìˆ˜ë¥¼ ì¼ë¶€ ì¬ì‚¬ìš©(ì•„ë˜)
      async function initQuestion(ord) {
        // ê¸°ì¡´ ì„œë²„-driven initQuestionì€ ë” ì´ìƒ ëª¨ë“  ì°¸ê°€ì ê°•ì œ ì´ë™ì— ì‚¬ìš©í•˜ì§€ ì•ŠìŒ.
        // ëŒ€ì‹ , ë‚¨ì•„ìˆëŠ” ì½”ë“œì™€ í˜¸í™˜ë˜ë„ë¡ ë¹ˆ ëŒ€ê¸° í‘œì‹œ ì²˜ë¦¬ë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
        clearTimer();
        feedbackEl.textContent = "";
        if (ord === null || ord === undefined || ord < 0) {
          questionText.textContent = "í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘í•˜ë©´ ë¬¸ì œê°€ ë‚˜ì˜µë‹ˆë‹¤.";
          questionImage.style.display = "none";
          answersEl.innerHTML = "";
          timeLeftEl.textContent = "0";
          return;
        }

        // (í˜¸ìŠ¤íŠ¸ê°€ current_question_ordë¥¼ ë°”ê¾¸ëŠ” ìš©ë„ë¡œ ì“°ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ”
        // ë³´ì¡°ì ì¸ ì—­í• ë§Œ í•©ë‹ˆë‹¤. ì‹¤ì œ ë¬¸ì œ ì§„í–‰ì€ local progressionìœ¼ë¡œ í•©ë‹ˆë‹¤.)
        // ì—¬ê¸°ì„œëŠ” ì•ˆì „ì„ ìœ„í•´ ë§Œì•½ localQuestions ë¹„ì–´ìˆë‹¤ë©´ ë¶ˆëŸ¬ì˜¤ëŠ” ì‹œë„ë¥¼ í•©ë‹ˆë‹¤.
        try {
          if (!Array.isArray(_localQuestions) || _localQuestions.length === 0) {
            const { data: game } = await db
              .from("games")
              .select("quiz_id")
              .eq("id", gameId)
              .single();
            const { data: questions } = await db
              .from("questions")
              .select("id,ord,text,image_url,timeout,double_points,answers(*)")
              .eq("quiz_id", game.quiz_id)
              .order("ord");
            _localQuestions = questions || [];
          }
        } catch (e) {
          console.warn("initQuestion fallback fetch err", e);
        }
      }

      async function renderQuestion(question) {
        // ì´ í•¨ìˆ˜ì€ server-driven íë¦„ì—ì„œ í˜¸ì¶œë  ìˆ˜ ìˆìœ¼ë‚˜,
        // ì´ë²ˆ ìˆ˜ì •ì—ì„œëŠ” ì°¸ê°€ì ê°œì¸ ì§„í–‰ì—ì„œ renderQuestionLocalì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // ë‚¨ê²¨ë‘ì–´ í˜¸í™˜ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        questionText.textContent = question.text || "(ë¬¸ì œ ì—†ìŒ)";
        if (question.image_url) {
          questionImage.src = question.image_url;
          questionImage.style.display = "block";
        } else {
          questionImage.style.display = "none";
        }

        answersEl.innerHTML = "";
        const { data: answers } = await db
          .from("answers")
          .select("*")
          .eq("question_id", question.id)
          .order("ord");
        answers.forEach((a) => {
          const btn = document.createElement("button");
          btn.className = "answer-btn";
          btn.textContent = a.text || "ë³´ê¸°";
          btn.onclick = () => submitAnswerAndNext(question, a); // ë³€ê²½: local flow ì‚¬ìš©
          answersEl.appendChild(btn);
        });

        clearTimer();
        questionStartTime = Date.now();
        startTimer(question.timeout || 30, () => {
          submitAnswerAndNext(question, null);
        });
      }

      function startTimer(seconds, onTimeout) {
        clearTimer();
        let left = seconds;
        timeLeftEl.textContent = left;
        questionStartTime = Date.now();
        timerInterval = setInterval(() => {
          left -= 1;
          timeLeftEl.textContent = left;
          if (left <= Math.max(0, Math.floor(seconds * 0.35))) {
            timeLeftEl.classList.add("timer-danger");
          } else {
            timeLeftEl.classList.remove("timer-danger");
          }
          if (left <= 0) {
            clearTimer();
            onTimeout && onTimeout();
          }
        }, 1000);
      }
      function clearTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      async function submitAnswer(question, answerObj) {
        // ê¸°ì¡´ ë¡œì§ ì¬ì‚¬ìš©: DBì— player_answers ì‚½ì…í•˜ê³  RPCë¡œ ì ìˆ˜ ì¦ê°€ ì²˜ë¦¬
        clearTimer();
        try {
          const timeTaken = Date.now() - (questionStartTime || Date.now());
          let selectedId = answerObj ? answerObj.id : null;
          let isCorrect = answerObj ? !!answerObj.is_correct : false;
          let score = 0;
          if (isCorrect) {
            const timeoutMs = (question.timeout || 30) * 1000;
            const base = 1000;
            const ratio = Math.max(0, Math.min(1, 1 - timeTaken / timeoutMs));
            const bonus = Math.max(200, Math.floor(700 * ratio));
            score = base + bonus;
            if (question.double_points) score *= 2;
          }

          const payload = {
            player_id: playerId,
            question_id: question.id,
            answer_id: selectedId,
            correct: isCorrect,
            time_ms: Math.floor(timeTaken),
            score,
          };
          const { error: insertErr } = await db
            .from("player_answers")
            .insert([payload]);
          if (insertErr)
            console.warn("player_answers insert error:", insertErr);

          if (score > 0) {
            const { error: rpcErr } = await db.rpc("increment_points", {
              pid: playerId,
              pscore: score,
            });
            if (rpcErr) console.warn("increment_points RPC error:", rpcErr);
          }

          feedbackEl.textContent = isCorrect ? `ì •ë‹µ! +${score}ì ` : `ì˜¤ë‹µ ğŸ˜­`;
        } catch (err) {
          console.error("submitAnswer err", err);
          safeAlert("ì œì¶œ ì‹¤íŒ¨: " + (err.message || err));
        }
      }

      function safeAlert(m) {
        try {
          alert(m);
        } catch (e) {
          console.log(m);
        }
      }

      (async () => {
        if (localStorage.getItem("nickname")) {
          nicknameInput.value = localStorage.getItem("nickname");
        }
        if (localStorage.getItem("playerId")) {
          await joinGame();
        }
      })();
    </script>
  </body>
</html>
