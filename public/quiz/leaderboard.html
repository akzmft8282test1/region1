<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>최종 리더보드</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">최종 리더보드</h1></header>

    <main style="padding: 1.25rem">
      <ul id="rankList"></ul>
    </main>

    <footer class="footer">© 2025 QuizMaker</footer>

    <script>
      


      // URL format: /quiz/:slug/leaderboard
      const parts = window.location.pathname.split("/");
      const slug = parts.length >= 3 ? parts[2] : null;

      const rankList = document.getElementById("rankList");

      async function loadLeaderboard() {
        if (!slug) {
          rankList.innerHTML = "<li>잘못된 경로</li>";
          return;
        }
        try {
          const { data: quiz } = await supabase
            .from("quizzes")
            .select("id,name")
            .eq("slug", slug)
            .maybeSingle();
          if (!quiz) {
            rankList.innerHTML = "<li>퀴즈를 찾을 수 없습니다</li>";
            return;
          }
          document.getElementById("quizTitle").textContent =
            `${quiz.name} - 최종 순위`;

          // 최근 생성된 game 찾기 (가장 최신)
          const { data: games } = await supabase
            .from("games")
            .select("id")
            .eq("quiz_id", quiz.id)
            .order("created_at", { ascending: false })
            .limit(1);
          if (!games || games.length === 0) {
            rankList.innerHTML = "<li>게임 세션이 없습니다</li>";
            return;
          }
          const gameId = games[0].id;

          const { data: players } = await supabase
            .from("players")
            .select("nickname,points")
            .eq("game_id", gameId)
            .order("points", { ascending: false });
          if (!players) {
            rankList.innerHTML = "<li>참가자가 없습니다</li>";
            return;
          }

          rankList.innerHTML = "";
          players.forEach((p, idx) => {
            const li = document.createElement("li");
            li.className =
              idx === 0 ? "top1" : idx === 1 ? "top2" : idx === 2 ? "top3" : "";
            li.innerHTML = `<span>${idx + 1}등 - ${p.nickname}</span><span>${p.points}점</span>`;
            rankList.appendChild(li);
          });
        } catch (err) {
          console.error("loadLeaderboard err", err);
          rankList.innerHTML = "<li>리더보드 로드 실패</li>";
        }
      }

      loadLeaderboard();
    </script>
  </body>
</html>
