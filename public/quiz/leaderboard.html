<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ìµœì¢… ìˆœìœ„</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .leaderboard {
        max-width: 600px;
        margin: 2rem auto;
        padding: 1rem;
        border-radius: 12px;
        background: #1e1e2f;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      }
      .leaderboard h2 {
        text-align: center;
        margin-bottom: 1rem;
      }
      .leaderboard li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        font-size: 1.1rem;
      }
      .leaderboard li.top1 {
        background: linear-gradient(90deg, #ffd700, #ffec8b);
        color: #000;
        font-weight: bold;
      }
      .leaderboard li.top2 {
        background: linear-gradient(90deg, #c0c0c0, #e0e0e0);
        color: #000;
        font-weight: bold;
      }
      .leaderboard li.top3 {
        background: linear-gradient(90deg, #cd7f32, #e6b98b);
        color: #000;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">ìµœì¢… ìˆœìœ„</h1></header>

    <main>
      <section class="leaderboard">
        <h2>ğŸ† ê²°ê³¼ ë°œí‘œ ğŸ†</h2>
        <ul id="rankList">
          <li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
        </ul>
      </section>
    </main>

    <footer class="footer">Â© 2025 QuizMaker</footer>

    <script>
      const parts = window.location.pathname.split("/");
      const slug = parts.length >= 3 ? parts[2] : null;
      const rankList = document.getElementById("rankList");

      async function loadLeaderboard() {
        if (!slug) {
          rankList.innerHTML = "<li>ì˜ëª»ëœ ê²½ë¡œì…ë‹ˆë‹¤.</li>";
          return;
        }
        try {
          // ğŸ”¹ í€´ì¦ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const { data: quiz } = await db
            .from("quizzes")
            .select("id,name")
            .eq("slug", slug)
            .maybeSingle();
          if (!quiz) {
            rankList.innerHTML = "<li>í€´ì¦ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
          }
          document.getElementById("quizTitle").textContent =
            `${quiz.name} â€” ìµœì¢… ìˆœìœ„`;

          // ğŸ”¹ ê°€ì¥ ìµœê·¼ ê²Œì„ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸°
          const { data: games } = await db
            .from("games")
            .select("id,created_at")
            .eq("quiz_id", quiz.id)
            .order("created_at", { ascending: false })
            .limit(1);
          if (!games || games.length === 0) {
            rankList.innerHTML = "<li>ê²Œì„ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
          }
          const gameId = games[0].id;

          // ğŸ”¹ ì°¸ê°€ì ë¶ˆëŸ¬ì˜¤ê¸°
          const { data: players } = await db
            .from("players")
            .select("nickname,points")
            .eq("game_id", gameId)
            .order("points", { ascending: false });
          if (!players || players.length === 0) {
            rankList.innerHTML = "<li>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
          }

          // ğŸ”¹ UI ì¶œë ¥
          rankList.innerHTML = "";
          players.forEach((p, idx) => {
            const li = document.createElement("li");
            if (idx === 0) li.className = "top1";
            else if (idx === 1) li.className = "top2";
            else if (idx === 2) li.className = "top3";
            li.innerHTML = `<span>${idx + 1}ë“± â€” ${p.nickname}</span><span>${p.points}ì </span>`;
            rankList.appendChild(li);
          });
        } catch (err) {
          console.error("loadLeaderboard err", err);
          rankList.innerHTML = "<li>ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨</li>";
        }
      }

      loadLeaderboard();
    </script>
  </body>
</html>
