<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>퀴즈 호스트</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">퀴즈 호스트</h1></header>

    <main class="main-container" style="grid-template-columns: 1fr">
      <section class="card">
        <div
          style="
            display: flex;
            gap: 0.75rem;
            align-items: center;
            justify-content: center;
          "
        >
          <button id="startBtn" class="btn-primary" aria-label="퀴즈 시작">
            퀴즈 시작
          </button>

          <button
            id="endGameBtn"
            class="btn-primary"
            style="background: linear-gradient(90deg, #ff5f6d, #ffc371)"
            aria-label="게임 종료"
          >
            게임 종료
          </button>
        </div>

        <div
          id="statusText"
          style="margin-top: 1rem; text-align: center; color: var(--muted)"
        >
          참가자를 기다리는 중...
        </div>
      </section>

      <section class="card">
        <h2>참가자 목록</h2>
        <table id="playerTable" aria-label="참가자 목록">
          <thead>
            <tr>
              <th>닉네임</th>
              <th>점수</th>
              <th>답변</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h2 style="margin-top: 1rem">실시간 순위</h2>
        <ul id="scoreboard"></ul>
      </section>
    </main>

    <footer class="footer">© 2025 QuizMaker - Host</footer>

    <script>
      // ✅ slug를 decodeURIComponent로 처리
      const slug = decodeURIComponent(
        window.location.pathname.split("/").pop(),
      );
      let gameId = null;

      const startBtn = document.getElementById("startBtn");
      const endGameBtn = document.getElementById("endGameBtn");
      const statusText = document.getElementById("statusText");
      const playerTableBody = document.querySelector("#playerTable tbody");
      const scoreboard = document.getElementById("scoreboard");

      async function ensureGame() {
        try {
          const { data: game } = await db
            .from("games")
            .select("id,quiz_id,started,current_question_ord,ended")
            .eq("slug", slug)
            .maybeSingle();
          if (game) {
            gameId = game.id;
            statusText.textContent = game.started ? "진행중" : "대기중";
            return;
          }
          const { data: quiz } = await db
            .from("quizzes")
            .select("id,name")
            .eq("slug", slug)
            .maybeSingle();
          if (!quiz) {
            alert("해당 퀴즈가 없습니다.");
            window.location.href = "/quizmaker";
            return;
          }
          const { data: newGame } = await db
            .from("games")
            .insert([{ quiz_id: quiz.id, slug }])
            .select()
            .single();
          gameId = newGame.id;
          document.getElementById("quizTitle").textContent =
            quiz.name + " (호스트)";
        } catch (err) {
          console.error("ensureGame", err);
          alert("게임 확보 실패: " + (err.message || err));
        }
      }

      async function loadPlayers() {
        if (!gameId) return;
        const { data: players } = await db
          .from("players")
          .select("id,nickname,points")
          .eq("game_id", gameId)
          .order("points", { ascending: false });
        if (!players) return;

        // ✅ 현재 문제 답변 여부 체크
        let answers = [];
        try {
          const { data: game } = await db
            .from("games")
            .select("current_question_ord,quiz_id")
            .eq("id", gameId)
            .single();
          if (game && game.current_question_ord >= 0) {
            const { data: q } = await db
              .from("questions")
              .select("id")
              .eq("quiz_id", game.quiz_id)
              .eq("ord", game.current_question_ord)
              .maybeSingle();
            if (q) {
              const { data: ans } = await db
                .from("player_answers")
                .select("player_id")
                .eq("question_id", q.id);
              answers = ans || [];
            }
          }
        } catch (err) {
          console.warn("loadPlayers answers check err", err);
        }

        playerTableBody.innerHTML = "";
        players.forEach((p) => {
          const tr = document.createElement("tr");
          const answered = answers.find((a) => a.player_id === p.id)
            ? "✅"
            : "❌";
          tr.innerHTML = `<td>${p.nickname}</td><td>${p.points}</td><td>${answered}</td>`;
          playerTableBody.appendChild(tr);
        });

        renderScoreboard(players);
        checkAllFinished();
      }

      function renderScoreboard(players) {
        scoreboard.innerHTML = "";
        players.forEach((p, idx) => {
          const li = document.createElement("li");
          li.className =
            idx === 0 ? "top1" : idx === 1 ? "top2" : idx === 2 ? "top3" : "";
          li.innerHTML = `<span>${idx + 1}등 - ${p.nickname}</span> <span>${p.points}점</span>`;
          scoreboard.appendChild(li);
        });
      }

      function subscribePlayers() {
        if (!gameId) return;
        db.channel("players-" + gameId)
          .on(
            "postgres_changes",
            {
              event: "*",
              schema: "public",
              table: "players",
              filter: `game_id=eq.${gameId}`,
            },
            loadPlayers,
          )
          .subscribe();
        db.channel("answers-" + gameId)
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "player_answers" },
            loadPlayers,
          )
          .subscribe();
      }

      function subscribeGame() {
        if (!gameId) return;
        db.channel("games-" + gameId)
          .on(
            "postgres_changes",
            {
              event: "UPDATE",
              schema: "public",
              table: "games",
              filter: `id=eq.${gameId}`,
            },
            (payload) => {
              const g = payload.new;
              statusText.textContent = g.started
                ? "진행중"
                : g.ended
                  ? "종료됨"
                  : "대기중";
              if (g.ended) {
                window.location.href = `/quiz/${slug}/leaderboard`;
              }
            },
          )
          .subscribe();
      }

      startBtn.addEventListener("click", async () => {
        if (!gameId) return;
        await db
          .from("games")
          .update({ started: true, current_question_ord: 0 })
          .eq("id", gameId);
        startBtn.style.display = "none";
      });

      endGameBtn.addEventListener("click", async () => {
        if (!confirm("게임을 종료하시겠습니까?")) return;
        await db.from("games").update({ ended: true }).eq("id", gameId);
        window.location.href = `/quiz/${slug}/leaderboard`;
      });

      async function checkAllFinished() {
        if (!gameId) return;
        try {
          const { data: game } = await db
            .from("games")
            .select("quiz_id")
            .eq("id", gameId)
            .single();
          if (!game) return;
          const { data: qlist } = await db
            .from("questions")
            .select("id")
            .eq("quiz_id", game.quiz_id);
          const totalQs = qlist ? qlist.length : 0;
          if (totalQs === 0) return;
          const { data: players } = await db
            .from("players")
            .select("id")
            .eq("game_id", gameId);
          if (!players || players.length === 0) return;
          const counts = await Promise.all(
            players.map(async (p) => {
              const { count } = await db
                .from("player_answers")
                .select("id", { count: "exact", head: true })
                .eq("player_id", p.id);
              return count || 0;
            }),
          );
          const allFinished = counts.every((c) => c >= totalQs);
          if (allFinished) {
            await db.from("games").update({ ended: true }).eq("id", gameId);
          }
        } catch (e) {
          console.warn("checkAllFinished err", e);
        }
      }

      (async () => {
        await ensureGame();
        await loadPlayers();
        subscribePlayers();
        subscribeGame();
      })();
    </script>
  </body>
</html>
