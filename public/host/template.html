<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>퀴즈 호스트</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .answer-list {
        display: grid;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .answer-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #2b2b3d;
        padding: 0.6rem;
        border-radius: 8px;
      }
      .answer-item img {
        max-width: 40px;
        max-height: 40px;
        border-radius: 6px;
      }
      .player-answered {
        color: #4caf50;
        font-weight: 600;
      }
      .player-waiting {
        color: #ccc;
      }
    </style>
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">퀴즈 호스트</h1></header>

    <main class="main-container" style="grid-template-columns: 1fr 1fr">
      <!-- 컨트롤 -->
      <section class="card">
        <div style="display: flex; gap: 0.75rem; justify-content: center">
          <button id="startBtn" class="btn-primary">퀴즈 시작</button>
          <button id="nextBtn" class="btn-primary" style="display: none">
            다음 문제 ▶
          </button>
          <button
            id="endGameBtn"
            class="btn-primary"
            style="background: linear-gradient(90deg, #ff5f6d, #ffc371)"
          >
            게임 종료
          </button>
        </div>

        <div
          id="statusText"
          style="margin-top: 1rem; text-align: center; color: var(--muted)"
        >
          참가자를 기다리는 중...
        </div>

        <h2 style="margin-top: 1rem">현재 문제</h2>
        <div id="questionBox" style="margin-top: 0.5rem">
          <div id="questionText"></div>
          <img
            id="questionImage"
            style="max-width: 240px; margin-top: 0.5rem; display: none"
            alt="문제 이미지"
          />
          <div id="answerList" class="answer-list"></div>
        </div>
      </section>

      <!-- 참가자 -->
      <section class="card">
        <h2>참가자 목록</h2>
        <table id="playerTable">
          <thead>
            <tr>
              <th>닉네임</th>
              <th>점수</th>
              <th>응답</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h2 style="margin-top: 1rem">실시간 순위</h2>
        <ul id="scoreboard"></ul>
      </section>
    </main>

    <footer class="footer">© 2025 QuizMaker - Host</footer>

    <script>
      const slug = window.location.pathname.split("/").pop();
      let gameId = null;
      let quizId = null;

      const startBtn = document.getElementById("startBtn");
      const nextBtn = document.getElementById("nextBtn");
      const endGameBtn = document.getElementById("endGameBtn");
      const statusText = document.getElementById("statusText");
      const playerTableBody = document.querySelector("#playerTable tbody");
      const scoreboard = document.getElementById("scoreboard");
      const qText = document.getElementById("questionText");
      const qImg = document.getElementById("questionImage");
      const answerList = document.getElementById("answerList");

      // 참가자 목록/순위 표시
      function renderPlayers(players, answeredSet) {
        playerTableBody.innerHTML = "";
        players.forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.nickname}</td>
            <td>${p.points}</td>
            <td>${
              answeredSet.has(p.id)
                ? '<span class="player-answered">✔</span>'
                : '<span class="player-waiting">…</span>'
            }</td>
          `;
          playerTableBody.appendChild(tr);
        });

        scoreboard.innerHTML = "";
        players.forEach((p, idx) => {
          const li = document.createElement("li");
          li.textContent = `${idx + 1}등 ${p.nickname} — ${p.points}점`;
          scoreboard.appendChild(li);
        });
      }

      async function ensureGame() {
        const { data: game } = await db
          .from("games")
          .select("id,quiz_id,started,current_question_ord,ended")
          .eq("slug", slug)
          .maybeSingle();
        if (!game) return;
        gameId = game.id;
        quizId = game.quiz_id;
        statusText.textContent = game.started ? "진행중" : "대기중";
        if (game.started) {
          nextBtn.style.display = "inline-block";
          initQuestion(game.current_question_ord);
        }
      }

      async function loadPlayers() {
        if (!gameId) return;
        const { data: players } = await db
          .from("players")
          .select("id,nickname,points")
          .eq("game_id", gameId)
          .order("points", { ascending: false });
        const { data: answers } = await db
          .from("player_answers")
          .select("player_id,question_id")
          .eq("question_id", currentQuestion?.id || -1);
        const answeredSet = new Set(answers?.map((a) => a.player_id));
        renderPlayers(players || [], answeredSet);
      }

      async function initQuestion(ord) {
        if (ord == null || ord < 0) {
          qText.textContent = "호스트가 시작 버튼을 눌러주세요.";
          qImg.style.display = "none";
          answerList.innerHTML = "";
          return;
        }
        const { data: question } = await db
          .from("questions")
          .select("id,text,image_url,timeout,double_points")
          .eq("quiz_id", quizId)
          .eq("ord", ord)
          .maybeSingle();
        if (!question) return;

        currentQuestion = question;
        qText.textContent = question.text;
        if (question.image_url) {
          qImg.src = question.image_url;
          qImg.style.display = "block";
        } else {
          qImg.style.display = "none";
        }

        const { data: answers } = await db
          .from("answers")
          .select("*")
          .eq("question_id", question.id)
          .order("ord");
        answerList.innerHTML = "";
        answers.forEach((a) => {
          const div = document.createElement("div");
          div.className = "answer-item";
          if (a.image_url) {
            const img = document.createElement("img");
            img.src = a.image_url;
            img.alt = "답변 이미지";
            div.appendChild(img);
          }
          const span = document.createElement("span");
          span.textContent = a.text || "보기";
          div.appendChild(span);
          answerList.appendChild(div);
        });

        loadPlayers();
      }

      // supabase realtime
      function subscribePlayers() {
        db.channel("players-" + gameId)
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "players" },
            loadPlayers,
          )
          .subscribe();
      }
      function subscribeAnswers() {
        db.channel("player_answers-" + gameId)
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "player_answers" },
            loadPlayers,
          )
          .subscribe();
      }
      function subscribeGame() {
        db.channel("games-" + gameId)
          .on(
            "postgres_changes",
            { event: "UPDATE", schema: "public", table: "games" },
            (payload) => {
              const g = payload.new;
              statusText.textContent = g.started
                ? "진행중"
                : g.ended
                  ? "종료됨"
                  : "대기중";
              if (g.ended) {
                window.location.href = `/quiz/${slug}/leaderboard`;
              } else {
                initQuestion(g.current_question_ord);
              }
            },
          )
          .subscribe();
      }

      // 버튼 이벤트
      startBtn.addEventListener("click", async () => {
        await db
          .from("games")
          .update({ started: true, current_question_ord: 0 })
          .eq("id", gameId);
        startBtn.style.display = "none";
        nextBtn.style.display = "inline-block";
      });
      nextBtn.addEventListener("click", async () => {
        const { data: game } = await db
          .from("games")
          .select("current_question_ord,quiz_id")
          .eq("id", gameId)
          .single();
        const { data: qList } = await db
          .from("questions")
          .select("id,ord")
          .eq("quiz_id", game.quiz_id)
          .order("ord");
        const total = qList.length;
        if (game.current_question_ord + 1 < total) {
          await db
            .from("games")
            .update({ current_question_ord: game.current_question_ord + 1 })
            .eq("id", gameId);
        } else {
          await db.from("games").update({ ended: true }).eq("id", gameId);
        }
      });
      endGameBtn.addEventListener("click", async () => {
        if (!confirm("게임을 종료하시겠습니까?")) return;
        await db.from("games").update({ ended: true }).eq("id", gameId);
        window.location.href = `/quiz/${slug}/leaderboard`;
      });

      let currentQuestion = null;

      (async () => {
        await ensureGame();
        subscribePlayers();
        subscribeAnswers();
        subscribeGame();
      })();
    </script>
  </body>
</html>
