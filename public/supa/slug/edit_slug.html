<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Slug 수정</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      /* 리스트 전체 박스 */
      #quizList {
        border: 2px solid #444;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 1rem;
      }

      /* 각 퀴즈 항목 */
      .quiz-item {
        padding: 1rem;
        border-bottom: 1px solid #444;
        background: #1e1e2f;
        color: #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .quiz-item:last-child {
        border-bottom: none;
      }

      .quiz-item:hover {
        background: #2c2c3d;
      }

      .quiz-title {
        font-weight: 600;
        font-size: 1rem;
      }

      .quiz-slug {
        font-size: 0.85rem;
        color: #aaa;
      }

      /* 펼쳐지는 상세 영역 (애니메이션) */
      .quiz-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .quiz-item.active .quiz-details {
        max-height: 200px; /* 폼 높이에 맞게 충분히 크게 */
      }

      .quiz-details-inner {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #666;
      }

      /* 버튼 */
      .quiz-details button {
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>퀴즈 Slug 수정</h1>
    </header>

    <main style="padding: 1.25rem; flex: 1">
      <section class="card">
        <h2>내 퀴즈 목록</h2>
        <div id="quizList">불러오는 중...</div>
      </section>
    </main>

    <footer class="footer">© 2025 QuizMaker</footer>

    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script>
      const quizListEl = document.getElementById("quizList");

      const token = localStorage.getItem("token");
      const isAdmin = localStorage.getItem("isAdmin") === "true";
      if (!token || !isAdmin) {
        alert("관리자 로그인이 필요합니다.");
        window.location.href = "/login";
      }

      const supabase = window.supabase.createClient(
        window.__SUPABASE_URL__,
        window.__SUPABASE_KEY__,
      );

      async function loadQuizzes() {
        const { data, error } = await supabase
          .from("quizzes")
          .select("id,name,slug,created_at");
        if (error) {
          quizListEl.textContent = "❌ 퀴즈 목록을 불러오지 못했습니다.";
          return;
        }

        if (!data || data.length === 0) {
          quizListEl.textContent = "아직 퀴즈가 없습니다.";
          return;
        }

        quizListEl.innerHTML = "";
        data.forEach((quiz) => {
          const item = document.createElement("div");
          item.className = "quiz-item";
          item.innerHTML = `
            <div class="quiz-title">${quiz.name}</div>
            <div class="quiz-slug">(slug: ${quiz.slug})</div>
            <div class="quiz-details">
              <div class="quiz-details-inner">
                <label for="slugInput-${quiz.id}">새로운 Slug</label>
                <input id="slugInput-${quiz.id}" type="text" class="input-text" placeholder="새로운 Slug 입력" />
                <button class="btn-primary updateBtn" data-id="${quiz.id}">Slug 수정</button>
                <p id="status-${quiz.id}" style="margin-top:0.5rem"></p>
              </div>
            </div>
          `;

          // 클릭 시 열고 닫기
          item.addEventListener("click", (e) => {
            if (e.target.classList.contains("updateBtn")) return;
            item.classList.toggle("active");
          });

          quizListEl.appendChild(item);
        });

        document.querySelectorAll(".updateBtn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const quizId = btn.dataset.id;
            const newSlug = document
              .getElementById(`slugInput-${quizId}`)
              .value.trim();
            const statusEl = document.getElementById(`status-${quizId}`);

            if (!newSlug) {
              statusEl.textContent = "새로운 Slug를 입력해주세요!";
              statusEl.style.color = "red";
              return;
            }

            try {
              const response = await fetch(`/supa/slug/${quizId}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ slug: newSlug }),
              });

              const result = await response.json();
              if (result.success) {
                statusEl.textContent = `✅ Slug가 수정되었습니다: ${newSlug}`;
                statusEl.style.color = "green";
                setTimeout(() => window.location.reload(), 10);
              } else {
                statusEl.textContent = result.error || "Slug 수정 실패";
                statusEl.style.color = "red";
              }
            } catch (err) {
              statusEl.textContent = "서버 오류 발생. 다시 시도하세요.";
              statusEl.style.color = "red";
            }
          });
        });
      }

      loadQuizzes();
    </script>
  </body>
</html>
