<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>퀴즈 관리</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">퀴즈 관리</h1></header>

    <main style="padding: 1.25rem">
      <section
        style="
          display: flex;
          gap: 0.5rem;
          align-items: center;
          margin-bottom: 1rem;
        "
      >
        <button id="addQuestionBtn" class="btn-primary">
          문제 추가하기 ➕
        </button>
        <button id="shareBtn" class="small-btn">공유 🔗</button>
        <button id="hostBtn" class="small-btn host">호스트 시작 🎤</button>
      </section>

      <section class="card">
        <h2>문제 리스트</h2>
        <ul id="questionList" style="list-style: none; padding: 0"></ul>
      </section>
    </main>

    <footer class="footer">© 2025 QuizMaker</footer>

    <!-- Modal -->
    <div
      id="questionModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          color: #111;
          padding: 1rem;
          width: 90%;
          max-width: 640px;
          border-radius: 12px;
        "
      >
        <h3 id="modalTitle">문제 만들기</h3>
        <label>문제 텍스트</label>
        <textarea
          id="questionText"
          class="input-text"
          style="height: 80px"
        ></textarea>

        <label>문제 이미지</label>
        <input
          id="questionImage"
          type="file"
          accept="image/*"
          class="input-file"
        />
        <div id="questionImagePreview" style="margin-top: 0.5rem"></div>

        <label>타임아웃(초)</label>
        <input
          id="timeout"
          class="input-text"
          type="number"
          min="5"
          value="30"
        />

        <div style="display: flex; gap: 1rem; margin-top: 0.5rem">
          <label><input id="doublePoints" type="checkbox" /> 점수 두배</label>
        </div>

        <h4 style="margin-top: 0.75rem">답변 (4개)</h4>
        <div id="answersContainer"></div>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
          "
        >
          <button id="saveQuestionBtn" class="btn-primary">저장</button>
          <button id="cancelModalBtn" class="small-btn secondary">취소</button>
        </div>
      </div>
    </div>

    <script>
      const slug = window.location.pathname.split("/").pop();
      const quizTitleEl = document.getElementById("quizTitle");
      const addBtn = document.getElementById("addQuestionBtn");
      const questionListEl = document.getElementById("questionList");
      const shareBtn = document.getElementById("shareBtn");
      const hostBtn = document.getElementById("hostBtn");

      const modal = document.getElementById("questionModal");
      const modalTitle = document.getElementById("modalTitle");
      const qText = document.getElementById("questionText");
      const qImage = document.getElementById("questionImage");
      const qImgPreview = document.getElementById("questionImagePreview");
      const timeoutEl = document.getElementById("timeout");
      const doublePointsEl = document.getElementById("doublePoints");
      const answersContainer = document.getElementById("answersContainer");
      const saveBtn = document.getElementById("saveQuestionBtn");
      const cancelBtn = document.getElementById("cancelModalBtn");

      let editingQuestionId = null;

      function openModal(edit = false) {
        modal.style.display = "flex";
        qText.value = "";
        qImage.value = "";
        qImgPreview.innerHTML = "";
        timeoutEl.value = 30;
        doublePointsEl.checked = false;
        renderAnswerInputs();
        editingQuestionId = null;
        modalTitle.textContent = edit ? "문제 수정" : "문제 만들기";
      }
      function closeModal() {
        modal.style.display = "none";
      }

      addBtn.addEventListener("click", () => openModal(false));
      cancelBtn.addEventListener("click", closeModal);

      function renderAnswerInputs(vals) {
        answersContainer.innerHTML = "";
        for (let i = 0; i < 4; i++) {
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.gap = "0.5rem";
          div.style.marginBottom = "0.4rem";
          const inTxt = document.createElement("input");
          inTxt.type = "text";
          inTxt.className = "input-text";
          inTxt.placeholder = `답변 ${i + 1}`;
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.title = "정답 여부";
          div.appendChild(inTxt);
          div.appendChild(chk);
          answersContainer.appendChild(div);
          if (vals && vals[i]) {
            inTxt.value = vals[i].text || "";
            chk.checked = !!vals[i].is_correct;
          }
        }
      }

      async function loadQuizAndQuestions() {
        try {
          const { data: quiz, error } = await db
            .from("quizzes")
            .select("*")
            .eq("slug", slug)
            .maybeSingle();
          if (error) throw error;
          if (!quiz) {
            alert("퀴즈를 찾을 수 없습니다.");
            window.location.href = "/quizmaker";
            return;
          }
          quizTitleEl.textContent = `퀴즈 관리 — ${quiz.name}`;

          const { data: questions } = await db
            .from("questions")
            .select("*")
            .eq("quiz_id", quiz.id)
            .order("ord", { ascending: true });
          questionListEl.innerHTML = "";
          if (!questions || questions.length === 0)
            questionListEl.innerHTML = "<li>아직 문제가 없습니다.</li>";
          else {
            questions.forEach((q, idx) => {
              const li = document.createElement("li");
              li.draggable = true;
              li.dataset.id = q.id;
              li.style.padding = "0.6rem";
              li.style.borderRadius = "8px";
              li.style.background = "rgba(255,255,255,0.03)";
              li.style.display = "flex";
              li.style.justifyContent = "space-between";
              li.style.alignItems = "center";
              li.innerHTML = `<span>${idx + 1}. ${q.text || "(문제 없음)"}</span>`;
              const box = document.createElement("div");
              box.style.display = "flex";
              box.style.gap = "0.4rem";
              const editBtn = document.createElement("button");
              editBtn.className = "small-btn";
              editBtn.textContent = "✏ 수정";
              editBtn.onclick = () => editQuestion(q.id);
              const delBtn = document.createElement("button");
              delBtn.className = "small-btn secondary";
              delBtn.textContent = "🗑 삭제";
              delBtn.onclick = () => deleteQuestion(q.id);
              const dupBtn = document.createElement("button");
              dupBtn.className = "small-btn";
              dupBtn.textContent = "📄 복제";
              dupBtn.onclick = () => duplicateQuestion(q.id);
              box.appendChild(editBtn);
              box.appendChild(dupBtn);
              box.appendChild(delBtn);
              li.appendChild(box);
              questionListEl.appendChild(li);
            });
            enableDragAndDrop();
          }
        } catch (err) {
          console.error("loadQuizAndQuestions", err);
          alert("문제 목록 불러오기 실패");
        }
      }

      saveBtn.addEventListener("click", async () => {
        const text = qText.value.trim();
        const timeout = parseInt(timeoutEl.value, 10) || 30;
        const doublePoints = doublePointsEl.checked;
        if (!text) {
          alert("문제를 입력하세요.");
          return;
        }

        try {
          const { data: quiz } = await db
            .from("quizzes")
            .select("id")
            .eq("slug", slug)
            .single();
          if (!quiz) throw new Error("quiz not found");

          let questionId = editingQuestionId;
          if (!questionId) {
            const { count } = await db
              .from("questions")
              .select("id", { head: true, count: "exact" })
              .eq("quiz_id", quiz.id);
            const ord = count || 0;
            const { data: q } = await db
              .from("questions")
              .insert([{ quiz_id: quiz.id, ord, text, timeout, double_points }])
              .select()
              .single();
            questionId = q.id;
          } else {
            await db
              .from("questions")
              .update({ text, timeout, double_points })
              .eq("id", questionId);
            await db.from("answers").delete().eq("question_id", questionId);
          }

          const ansInserts = [];
          Array.from(answersContainer.children).forEach((div, idx) => {
            const atext =
              div.querySelector('input[type="text"]').value.trim() ||
              `답변 ${idx + 1}`;
            const isCorrect = div.querySelector(
              'input[type="checkbox"]',
            ).checked;
            ansInserts.push({
              question_id: questionId,
              ord: idx,
              text: atext,
              is_correct: isCorrect,
            });
          });
          if (ansInserts.length) await db.from("answers").insert(ansInserts);

          alert("저장되었습니다 ✅");
          closeModal();
          loadQuizAndQuestions();
        } catch (err) {
          console.error("save question err", err);
          alert("문제 저장 실패: " + (err.message || err));
        }
      });

      async function editQuestion(qid) {
        try {
          const { data: q } = await db
            .from("questions")
            .select("*")
            .eq("id", qid)
            .single();
          const { data: answers } = await db
            .from("answers")
            .select("*")
            .eq("question_id", qid)
            .order("ord");
          editingQuestionId = qid;
          openModal(true);
          qText.value = q.text || "";
          timeoutEl.value = q.timeout || 30;
          doublePointsEl.checked = !!q.double_points;
          renderAnswerInputs(answers || []);
        } catch (err) {
          console.error(err);
          alert("편집용 데이터 로드 실패");
        }
      }

      async function deleteQuestion(qid) {
        if (!confirm("문제를 삭제하시겠습니까?")) return;
        try {
          await db.from("questions").delete().eq("id", qid);
          await db.from("answers").delete().eq("question_id", qid);
          loadQuizAndQuestions();
        } catch (err) {
          console.error(err);
          alert("삭제 실패");
        }
      }

      async function duplicateQuestion(qid) {
        try {
          const { data: q } = await db
            .from("questions")
            .select("*")
            .eq("id", qid)
            .single();
          const { data: answers } = await db
            .from("answers")
            .select("*")
            .eq("question_id", qid)
            .order("ord");
          const { data: newQ } = await db
            .from("questions")
            .insert([
              {
                quiz_id: q.quiz_id,
                text: q.text + " (복제)",
                timeout: q.timeout,
                double_points: q.double_points,
              },
            ])
            .select()
            .single();
          if (answers && answers.length) {
            const clones = answers.map((a) => ({
              question_id: newQ.id,
              ord: a.ord,
              text: a.text,
              is_correct: a.is_correct,
            }));
            await db.from("answers").insert(clones);
          }
          loadQuizAndQuestions();
        } catch (err) {
          console.error(err);
          alert("복제 실패");
        }
      }

      function enableDragAndDrop() {
        const list = questionListEl;
        let dragItem = null;
        list.querySelectorAll("li").forEach((li) => {
          li.addEventListener("dragstart", () => {
            dragItem = li;
            setTimeout(() => (li.style.opacity = "0.4"), 0);
          });
          li.addEventListener("dragend", () => {
            li.style.opacity = "1";
            dragItem = null;
          });
          li.addEventListener("dragover", (e) => {
            e.preventDefault();
            const draggingOver = li;
            if (dragItem && draggingOver !== dragItem) {
              const items = [...list.children];
              const dragIndex = items.indexOf(dragItem);
              const overIndex = items.indexOf(draggingOver);
              if (dragIndex < overIndex)
                list.insertBefore(dragItem, draggingOver.nextSibling);
              else list.insertBefore(dragItem, draggingOver);
            }
          });
        });

        list.addEventListener("drop", async () => {
          const items = [...list.children];
          for (let i = 0; i < items.length; i++) {
            const id = items[i].dataset.id;
            await db.from("questions").update({ ord: i }).eq("id", id);
          }
          loadQuizAndQuestions();
        });
      }

      shareBtn.addEventListener("click", async () => {
        const url = `${window.location.origin}/quiz/${slug}`;
        try {
          await navigator.clipboard.writeText(url);
          alert("복사됨: " + url);
        } catch (e) {
          alert(url);
        }
      });
      hostBtn.addEventListener("click", () => {
        window.location.href = `/host/${slug}`;
      });

      loadQuizAndQuestions();
    </script>
  </body>
</html>
