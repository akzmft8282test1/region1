<!doctype html>
<html lang="ko">
  <head>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="/app.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>퀴즈 관리</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      /* 모달 스타일 */
      #questionModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #questionModal .modal-content {
        background: #1e1e2f;
        color: #f0f0f0;
        padding: 1.5rem;
        width: 90%;
        max-width: 640px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        animation: fadeIn 0.25s ease-in-out;
      }
      #questionModal label {
        display: block;
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
        font-weight: 600;
      }
      #questionModal textarea,
      #questionModal input[type="text"],
      #questionModal input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #444;
        background: #2b2b3d;
        color: #fff;
      }
      #answersContainer div {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.4rem;
        align-items: center;
      }
      #answersContainer input[type="text"] {
        flex: 1;
      }
      #answersContainer img {
        max-width: 40px;
        max-height: 40px;
        border-radius: 6px;
      }
      #questionModal .actions {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1rem;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <header class="header"><h1 id="quizTitle">퀴즈 관리</h1></header>

    <main style="padding: 1.25rem">
      <section
        style="
          display: flex;
          gap: 0.5rem;
          align-items: center;
          margin-bottom: 1rem;
        "
      >
        <button id="addQuestionBtn" class="btn-primary">
          문제 추가하기 ➕
        </button>
        <button id="shareBtn" class="small-btn">공유 🔗</button>
        <button id="hostBtn" class="small-btn host">호스트 시작 🎤</button>
      </section>

      <section class="card">
        <h2>문제 리스트</h2>
        <ul id="questionList" style="list-style: none; padding: 0"></ul>
      </section>
    </main>

    <footer class="footer">© 2025 QuizMaker</footer>

    <!-- Modal -->
    <div id="questionModal">
      <div class="modal-content">
        <h3 id="modalTitle">문제 만들기</h3>
        <label for="questionText">문제 텍스트</label>
        <textarea
          id="questionText"
          class="input-text"
          style="height: 80px"
        ></textarea>

        <label for="questionImage">문제 이미지</label>
        <input
          id="questionImage"
          type="file"
          accept="image/*"
          class="input-file"
        />
        <img
          id="questionImagePreview"
          alt="문제 이미지 미리보기"
          style="
            max-width: 160px;
            margin-top: 0.5rem;
            border-radius: 8px;
            display: none;
          "
        />

        <label for="timeout">타임아웃(초)</label>
        <input
          id="timeout"
          class="input-text"
          type="number"
          min="5"
          value="30"
        />

        <div style="display: flex; gap: 1rem; margin-top: 0.5rem">
          <label><input id="doublePoints" type="checkbox" /> 점수 두배</label>
        </div>

        <h4 style="margin-top: 0.75rem">답변 (4개)</h4>
        <div id="answersContainer"></div>

        <div class="actions">
          <button id="saveQuestionBtn" class="btn-primary">저장</button>
          <button id="cancelModalBtn" class="small-btn secondary">취소</button>
        </div>
      </div>
    </div>

    <script>
      const slug = window.location.pathname.split("/").pop();
      const quizTitleEl = document.getElementById("quizTitle");
      const addBtn = document.getElementById("addQuestionBtn");
      const questionListEl = document.getElementById("questionList");
      const shareBtn = document.getElementById("shareBtn");
      const hostBtn = document.getElementById("hostBtn");

      const modal = document.getElementById("questionModal");
      const modalTitle = document.getElementById("modalTitle");
      const qText = document.getElementById("questionText");
      const qImage = document.getElementById("questionImage");
      const qImgPreview = document.getElementById("questionImagePreview");
      const timeoutEl = document.getElementById("timeout");
      const doublePointsEl = document.getElementById("doublePoints");
      const answersContainer = document.getElementById("answersContainer");
      const saveBtn = document.getElementById("saveQuestionBtn");
      const cancelBtn = document.getElementById("cancelModalBtn");

      let editingQuestionId = null;

      function openModal(edit = false, q = null) {
        modal.style.display = "flex";
        qText.value = q?.text || "";
        timeoutEl.value = q?.timeout || 30;
        doublePointsEl.checked = !!q?.double_points;
        qImage.value = "";
        if (q?.image_url) {
          qImgPreview.src = q.image_url;
          qImgPreview.style.display = "block";
        } else {
          qImgPreview.style.display = "none";
        }
        renderAnswerInputs();
        editingQuestionId = q?.id || null;
        modalTitle.textContent = edit ? "문제 수정" : "문제 만들기";
      }
      function closeModal() {
        modal.style.display = "none";
      }

      addBtn.addEventListener("click", () => openModal(false));
      cancelBtn.addEventListener("click", closeModal);

      qImage.addEventListener("change", (e) => {
        const f = e.target.files[0];
        if (!f) {
          qImgPreview.style.display = "none";
          return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
          qImgPreview.src = ev.target.result;
          qImgPreview.style.display = "block";
        };
        reader.readAsDataURL(f);
      });

      function renderAnswerInputs(vals) {
        answersContainer.innerHTML = "";
        for (let i = 0; i < 4; i++) {
          const div = document.createElement("div");
          const inTxt = document.createElement("input");
          inTxt.type = "text";
          inTxt.className = "input-text";
          inTxt.placeholder = `답변 ${i + 1}`;
          inTxt.style.flex = "1";
          const chk = document.createElement("input");
          chk.type = "checkbox";
          chk.title = "정답 여부";
          div.appendChild(inTxt);
          div.appendChild(chk);
          answersContainer.appendChild(div);
          if (vals && vals[i]) {
            inTxt.value = vals[i].text || "";
            chk.checked = !!vals[i].is_correct;
          }
        }
      }

      async function loadQuizAndQuestions() {
        try {
          const { data: quiz } = await db
            .from("quizzes")
            .select("*")
            .eq("slug", slug)
            .maybeSingle();
          if (!quiz) {
            alert("퀴즈를 찾을 수 없습니다.");
            window.location.href = "/quizmaker";
            return;
          }
          quizTitleEl.textContent = `퀴즈 관리 — ${quiz.name}`;

          const { data: questions } = await db
            .from("questions")
            .select("*")
            .eq("quiz_id", quiz.id)
            .order("ord", { ascending: true });
          questionListEl.innerHTML = "";
          if (!questions || questions.length === 0)
            questionListEl.innerHTML = "<li>아직 문제가 없습니다.</li>";
          else {
            questions.forEach((q, idx) => {
              const li = document.createElement("li");
              li.draggable = true;
              li.dataset.id = q.id;
              li.style.padding = "0.6rem";
              li.style.borderRadius = "8px";
              li.style.background = "rgba(255,255,255,0.03)";
              li.style.display = "flex";
              li.style.justifyContent = "space-between";
              li.style.alignItems = "center";

              let inner = `${idx + 1}. ${q.text || "(문제 없음)"}`;
              if (q.image_url) {
                inner += ` <img src="${q.image_url}" alt="문제 이미지" style="max-width:40px;max-height:40px;border-radius:6px;margin-left:0.5rem"/>`;
              }

              li.innerHTML = `<span>${inner}</span>`;
              const box = document.createElement("div");
              box.style.display = "flex";
              box.style.gap = "0.4rem";
              const editBtn = document.createElement("button");
              editBtn.className = "small-btn";
              editBtn.textContent = "✏ 수정";
              editBtn.onclick = () => editQuestion(q.id);
              const delBtn = document.createElement("button");
              delBtn.className = "small-btn secondary";
              delBtn.textContent = "🗑 삭제";
              delBtn.onclick = () => deleteQuestion(q.id);
              box.appendChild(editBtn);
              box.appendChild(delBtn);
              li.appendChild(box);
              questionListEl.appendChild(li);
            });
          }
        } catch (err) {
          console.error("loadQuizAndQuestions", err);
          alert("문제 목록 불러오기 실패");
        }
      }

      saveBtn.addEventListener("click", async () => {
        const text = qText.value.trim();
        const timeout = parseInt(timeoutEl.value, 10) || 30;
        const doublePoints = doublePointsEl.checked;
        if (!text) {
          alert("문제를 입력하세요.");
          return;
        }

        try {
          const { data: quiz } = await db
            .from("quizzes")
            .select("id")
            .eq("slug", slug)
            .single();
          if (!quiz) throw new Error("quiz not found");

          let questionId = editingQuestionId;
          let imageUrl = null;

          if (qImage.files && qImage.files[0]) {
            const ext = qImage.files[0].name.split(".").pop();
            const path = `question-images/${Date.now()}.${ext}`;
            imageUrl = await uploadImage(qImage.files[0], path);
          }

          if (!questionId) {
            const { count } = await db
              .from("questions")
              .select("id", { head: true, count: "exact" })
              .eq("quiz_id", quiz.id);
            const ord = count || 0;
            const { data: q } = await db
              .from("questions")
              .insert([
                {
                  quiz_id: quiz.id,
                  ord,
                  text,
                  timeout,
                  double_points: doublePoints,
                  image_url: imageUrl,
                },
              ])
              .select()
              .single();
            questionId = q.id;
          } else {
            const updateData = { text, timeout, double_points: doublePoints };
            if (imageUrl) updateData.image_url = imageUrl;
            await db.from("questions").update(updateData).eq("id", questionId);
            await db.from("answers").delete().eq("question_id", questionId);
          }

          const ansInserts = [];
          Array.from(answersContainer.children).forEach((div, idx) => {
            const atext =
              div.querySelector('input[type="text"]').value.trim() ||
              `답변 ${idx + 1}`;
            const isCorrect = div.querySelector(
              'input[type="checkbox"]',
            ).checked;
            ansInserts.push({
              question_id: questionId,
              ord: idx,
              text: atext,
              is_correct: isCorrect,
            });
          });
          if (ansInserts.length) await db.from("answers").insert(ansInserts);

          alert("저장되었습니다 ✅");
          closeModal();
          loadQuizAndQuestions();
        } catch (err) {
          console.error("save question err", err);
          alert("문제 저장 실패: " + (err.message || err));
        }
      });

      async function editQuestion(qid) {
        try {
          const { data: q } = await db
            .from("questions")
            .select("*")
            .eq("id", qid)
            .single();
          const { data: answers } = await db
            .from("answers")
            .select("*")
            .eq("question_id", qid)
            .order("ord");
          editingQuestionId = qid;
          openModal(true, q);
          renderAnswerInputs(answers || []);
        } catch (err) {
          console.error(err);
          alert("편집용 데이터 로드 실패");
        }
      }

      async function deleteQuestion(qid) {
        if (!confirm("문제를 삭제하시겠습니까?")) return;
        try {
          await db.from("questions").delete().eq("id", qid);
          await db.from("answers").delete().eq("question_id", qid);
          loadQuizAndQuestions();
        } catch (err) {
          console.error(err);
          alert("삭제 실패");
        }
      }

      shareBtn.addEventListener("click", async () => {
        const url = `${window.location.origin}/quiz/${slug}`;
        try {
          await navigator.clipboard.writeText(url);
          alert(
            "복사됨: " +
              url +
              "\n참가자는 이 링크로 접속해 닉네임을 입력 후 대기합니다.",
          );
        } catch (e) {
          alert(url);
        }
      });

      hostBtn.addEventListener("click", () => {
        window.location.href = `/host/${slug}`;
      });

      loadQuizAndQuestions();
    </script>
  </body>
</html>
